# 勤怠管理システム - 認証システム

## 概要

この勤怠管理システムには、パスワードベースの認証システムが実装されています。システムにアクセスするには、事前に設定されたパスワードでの認証が必要です。

## 認証システムの構成

### 1. 認証フロー

```
ユーザーアクセス → ミドルウェア認証チェック → 認証済み: メインページ / 未認証: ログインページ
```

### 2. 主要コンポーネント

#### フロントエンド
- **ログインページ** (`/login`): パスワード入力フォーム
- **ログインフォーム** (`components/LoginForm.tsx`): 認証UI
- **ミドルウェア** (`middleware.ts`): ページアクセス制御

#### バックエンドAPI
- **ログインAPI** (`/api/auth/login`): パスワード認証
- **認証チェックAPI** (`/api/auth/check`): 認証状態確認
- **ログアウトAPI** (`/api/auth/logout`): セッション削除

## 使用方法

### 初回アクセス

1. **アプリケーション起動**
   ```bash
   npm run dev
   ```

2. **ブラウザでアクセス**
   - URL: `http://localhost:3000`
   - 自動的にログインページ (`/login`) にリダイレクト

3. **ログイン**
   - パスワード: `admin123` (デフォルト)
   - 「ログイン」ボタンをクリック

4. **メインページへ遷移**
   - 認証成功後、勤怠管理システムのメインページに自動遷移

### ログアウト

1. **ログアウトボタンをクリック**
   - メインページ右上の「ログアウト」ボタン

2. **ログインページに戻る**
   - 自動的にログインページにリダイレクト

## セキュリティ設定

### 環境変数

```bash
# .env.local ファイルに設定
ADMIN_PASSWORD=your_secure_password_here
```

### デフォルト設定

- **デフォルトパスワード**: `admin123`
- **セッション有効期限**: 24時間
- **セキュリティ**: HTTPクッキー（本番環境ではHTTPS必須）

## 保護されたページ

以下のページは認証が必要です：

- `/` - メインページ（勤怠打刻）
- `/admin` - 管理画面

## 認証状態の管理

### セッション管理

- **認証成功時**: `auth-session` クッキーに `authenticated` 値を設定
- **認証失敗時**: クッキーを削除
- **自動リダイレクト**: 未認証ユーザーは自動的にログインページへ

### セッションの特徴

```typescript
// セッション設定
cookieStore.set("auth-session", "authenticated", {
  httpOnly: true,                    // JavaScriptからアクセス不可
  secure: process.env.NODE_ENV === "production", // 本番環境ではHTTPS必須
  sameSite: "lax",                   // CSRF攻撃対策
  maxAge: 60 * 60 * 24,             // 24時間有効
});
```

## エラーハンドリング

### 認証エラー

- **パスワード不一致**: "パスワードが正しくありません"
- **空のパスワード**: "パスワードが入力されていません"
- **サーバーエラー**: "エラーが発生しました"

### セキュリティエラー

- **未認証アクセス**: 自動的にログインページにリダイレクト
- **セッション期限切れ**: 再認証が必要

## 開発者向け情報

### API エンドポイント

#### POST `/api/auth/login`
```typescript
// リクエスト
{
  "password": "admin123"
}

// レスポンス（成功）
{
  "success": true
}

// レスポンス（失敗）
{
  "error": "パスワードが正しくありません"
}
```

#### GET `/api/auth/check`
```typescript
// レスポンス
{
  "authenticated": true | false
}
```

#### POST `/api/auth/logout`
```typescript
// レスポンス
{
  "success": true
}
```

### ミドルウェア設定

```typescript
// middleware.ts
export const config = {
  matcher: [
    "/((?!_next/static|_next/image|favicon.ico).*)",
  ],
};
```

## 本番環境での設定

### 1. 環境変数の設定

```bash
# 本番環境用の強力なパスワードを設定
ADMIN_PASSWORD=your_very_secure_password_here
```

### 2. HTTPS設定

- 本番環境では必ずHTTPSを使用
- セキュリティクッキーが有効になります

### 3. セキュリティ推奨事項

- 定期的なパスワード変更
- 強力なパスワードの使用
- ログの監視
- セッション管理の監視

## トラブルシューティング

### よくある問題

1. **ログインできない**
   - パスワードが正しいか確認
   - ブラウザのクッキーが有効か確認

2. **セッションが切れる**
   - 24時間経過で自動的に期限切れ
   - 再ログインが必要

3. **リダイレクトループ**
   - ブラウザのキャッシュをクリア
   - クッキーを削除して再試行

### デバッグ方法

```bash
# 開発サーバー起動
npm run dev

# ログの確認
# ブラウザの開発者ツールでネットワークタブを確認
```

## 今後の拡張予定

- ユーザー管理機能
- ロールベースアクセス制御
- 多要素認証
- セッション管理の強化
- 監査ログ機能

---

**注意**: 本番環境では必ず強力なパスワードを設定し、定期的に変更してください。
